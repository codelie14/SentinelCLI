"""
Vulnerability Assessment Module - Identifies potential vulnerabilities
"""

from typing import Dict, List, Any
from datetime import datetime


class VulnerabilityAssessment:
    """Assess system vulnerabilities based on analysis"""
    
    def __init__(self):
        # Common CVE patterns and known vulnerabilities
        self.known_vulnerabilities = {
            'WinLogonRCE': {
                'cve': 'CVE-2021-1732',
                'name': 'Windows logon UI RCE',
                'severity': 'CRITICAL',
                'description': 'Remote code execution through logon UI',
                'affected': ['Windows 10', 'Windows 11'],
                'mitigation': 'Apply Windows security updates'
            },
            'SMBBlueKeep': {
                'cve': 'CVE-2019-0708',
                'name': 'SMB BlueKeep Vulnerability',
                'severity': 'CRITICAL',
                'description': 'RCE in Remote Desktop Protocol',
                'affected': ['Windows 7', 'Windows Server 2008'],
                'mitigation': 'Disable RDP or apply patches. Port 3389 should be closed.'
            },
            'PrinterSpooler': {
                'cve': 'CVE-2021-1675',
                'name': 'Windows Print Spooler RCE',
                'severity': 'CRITICAL',
                'description': 'Remote code execution in Print Spooler',
                'affected': ['Windows Server 2012+'],
                'mitigation': 'Disable Print Spooler if not needed'
            },
            'EternaBlue': {
                'cve': 'CVE-2017-0144',
                'name': 'EternalBlue SMB Exploit',
                'severity': 'CRITICAL',
                'description': 'SMB port 445 exploitation',
                'affected': ['Windows Vista+', 'All Windows'],
                'mitigation': 'Keep SMB updated, restrict access to port 445'
            }
        }
    
    def scan_vulnerabilities(self, system_info: Dict[str, Any],
                            open_ports: Dict[int, Any],
                            processes: List[Dict[str, Any]]) -> Dict[str, Any]:
        """Scan system for potential vulnerabilities"""
        
        vulnerabilities = []
        risk_score = 0
        
        # Check OS-specific vulnerabilities
        os_vulns = self._check_os_vulnerabilities(system_info)
        vulnerabilities.extend(os_vulns['vulnerabilities'])
        risk_score += os_vulns['risk_score']
        
        # Check port-based vulnerabilities
        port_vulns = self._check_port_vulnerabilities(open_ports)
        vulnerabilities.extend(port_vulns['vulnerabilities'])
        risk_score += port_vulns['risk_score']
        
        # Check process vulnerabilities
        proc_vulns = self._check_process_vulnerabilities(processes)
        vulnerabilities.extend(proc_vulns['vulnerabilities'])
        risk_score += proc_vulns['risk_score']
        
        return {
            'vulnerabilities': vulnerabilities,
            'vulnerability_count': len(vulnerabilities),
            'risk_score': min(100, risk_score),
            'severity_breakdown': self._count_by_severity(vulnerabilities),
            'timestamp': datetime.now().isoformat()
        }
    
    def _check_os_vulnerabilities(self, system_info: Dict[str, Any]) -> Dict[str, Any]:
        """Check for OS-specific vulnerabilities"""
        
        vulnerabilities = []
        risk_score = 0
        os = system_info.get('os', '').lower()
        
        # Windows vulnerabilities
        if 'windows' in os:
            # All Windows versions are vulnerable to PrinterSpooler
            vulnerabilities.append({
                'vulnerability': self.known_vulnerabilities['PrinterSpooler'],
                'status': 'POTENTIAL',
                'recommendation': 'Verify Print Spooler service status'
            })
            risk_score += 15
        
        return {
            'vulnerabilities': vulnerabilities,
            'risk_score': risk_score
        }
    
    def _check_port_vulnerabilities(self, open_ports: Dict[int, Any]) -> Dict[str, Any]:
        """Check for port-specific vulnerabilities"""
        
        vulnerabilities = []
        risk_score = 0
        
        ports_to_check = {
            3389: 'SMBBlueKeep',    # RDP
            445: 'EternaBlue',      # SMB
            139: 'EternaBlue',      # NetBIOS
        }
        
        for port, vuln_key in ports_to_check.items():
            if port in open_ports:
                vulnerabilities.append({
                    'vulnerability': self.known_vulnerabilities.get(
                        vuln_key,
                        {'name': 'Unknown vulnerability', 'severity': 'MEDIUM'}
                    ),
                    'exposed_port': port,
                    'status': 'ACTIVE',
                    'recommendation': f'Port {port} is open and exposed to this vulnerability'
                })
                risk_score += 20
        
        return {
            'vulnerabilities': vulnerabilities,
            'risk_score': risk_score
        }
    
    def _check_process_vulnerabilities(self, processes: List[Dict[str, Any]]) -> Dict[str, Any]:
        """Check for process-related vulnerabilities"""
        
        vulnerabilities = []
        risk_score = 0
        
        for proc in processes:
            name = proc.get('name', '').lower()
            
            # Check for potentially vulnerable services
            if 'spoolsv' in name:  # Print Spooler
                vulnerabilities.append({
                    'vulnerability': self.known_vulnerabilities['PrinterSpooler'],
                    'process': name,
                    'status': 'CONFIRMED',
                    'recommendation': 'Disable Print Spooler if not needed'
                })
                risk_score += 15
        
        return {
            'vulnerabilities': vulnerabilities,
            'risk_score': risk_score
        }
    
    def _count_by_severity(self, vulnerabilities: List[Dict[str, Any]]) -> Dict[str, int]:
        """Count vulnerabilities by severity"""
        
        severity_count = {
            'CRITICAL': 0,
            'HIGH': 0,
            'MEDIUM': 0,
            'LOW': 0
        }
        
        for vuln in vulnerabilities:
            severity = vuln.get('vulnerability', {}).get('severity', 'MEDIUM')
            severity_count[severity] = severity_count.get(severity, 0) + 1
        
        return severity_count
    
    def get_mitigation_steps(self, vulnerabilities: List[Dict[str, Any]]) -> List[str]:
        """Get mitigation steps for found vulnerabilities"""
        
        steps = []
        seen_mitigations = set()
        
        for vuln in vulnerabilities:
            mitigation = vuln.get('vulnerability', {}).get('mitigation', '')
            if mitigation and mitigation not in seen_mitigations:
                steps.append(mitigation)
                seen_mitigations.add(mitigation)
        
        if not steps:
            steps.append("No specific mitigations found. Keep system updated.")
        
        return steps
    
    def generate_vulnerability_report(self, vuln_scan: Dict[str, Any]) -> str:
        """Generate human-readable vulnerability report"""
        
        report = []
        report.append("=" * 60)
        report.append("VULNERABILITY ASSESSMENT REPORT")
        report.append("=" * 60)
        report.append(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        report.append("")
        
        # Summary
        severity = vuln_scan.get('severity_breakdown', {})
        report.append("SUMMARY:")
        report.append(f"Total Vulnerabilities: {vuln_scan.get('vulnerability_count', 0)}")
        report.append(f"  - CRITICAL: {severity.get('CRITICAL', 0)}")
        report.append(f"  - HIGH: {severity.get('HIGH', 0)}")
        report.append(f"  - MEDIUM: {severity.get('MEDIUM', 0)}")
        report.append(f"  - LOW: {severity.get('LOW', 0)}")
        report.append("")
        
        # Risk Score
        report.append(f"RISK SCORE: {vuln_scan.get('risk_score', 0)}/100")
        report.append("")
        
        # Details
        if vuln_scan.get('vulnerabilities'):
            report.append("VULNERABLE ITEMS:")
            for vuln in vuln_scan.get('vulnerabilities', []):
                vuln_info = vuln.get('vulnerability', {})
                report.append(f"\n  [{vuln_info.get('severity')}] {vuln_info.get('name')}")
                report.append(f"  CVE: {vuln_info.get('cve')}")
                report.append(f"  Status: {vuln.get('status')}")
                report.append(f"  Recommendation: {vuln.get('recommendation')}")
        
        return "\n".join(report)
